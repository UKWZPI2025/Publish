<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Moje wizyty</title>
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/wizyty_uzytkownik_style.css">
    <script defer src="js/wizyty_uzytkownik.js"></script>
</head>
<body>
    <div class="main">
        <div class="header_resize">
            <div class="logo">
                <h1><a href="#"><span>ŁUK</span></a> <small>klinika ortodontyczna</small></h1>
            </div>
            <div class="clr"></div>

            <!-- Główne menu -->
            <div class="menu_nav">
                <ul class="main_menu">
                    <li><a href="index_uzytkownik.html">Home</a></li>
                    <li class="active"><a href="wizyty_uzytkownik.html">Wizyty</a></li>
                    <li><a href="wiadomosci_uzytkownik.html">Wiadomości i powiadomienia</a></li>
                    <li><a href="panel_uzytkownik.html">Panel użytkownika</a></li>
                </ul>
                <ul class="user_menu">
                    <li><a id="powitanie" href="#">Witaj!</a></li>
                    <li><a href="index_gosc.html">Wyloguj</a></li>
                </ul>
                <div class="clr"></div>
            </div>
        </div>

        <div class="content_resize">
            <div class="content">
                <div class="mainbar">
                    <div class="article">
                        <h2 class="fancy-title">Twoje zaplanowane wizyty</h2>
                        <div id="komunikat"></div>
                        <div id="komunikatGrafik"></div>
                        <div id="freedBanner" class="freed-banner" style="display:none;">
                        <div class="freed-banner__title">Zwolnił się wcześniejszy termin</div>
                        <div id="freedText" class="freed-banner__text"></div>
                        <div class="freed-banner__actions">
                          <button id="freedAccept" type="button">Umów na wcześniejszy</button>
                          <button id="freedDismiss" type="button">Nie teraz</button>
                        </div>
                      </div>
                        <div id="listaWizyt" class="listaWizyt"></div>
                        <hr />
                        <h2 class="fancy-title">Umów nową wizytę</h2>
                        <form id="formWizyta">
                            <label for="lekarz">Lekarz:</label>
                            <select id="lekarz">
                                <option value="">-- Wybierz lekarza --</option>
                            </select>
                            <br><br>

                            <label for="data">Data wizyty:</label>
                            <input type="date" id="data" name="data"><br><br>

                            <label for="godzina">Godzina wizyty:</label>
                            <div id="godzina-tiles" class="godzina-tiles"></div>
                            <input type="hidden" id="godzina" name="godzina">
                            <br><br>

                            <label for="usluga">Usługa:</label>
                            <select id="usluga" name="usluga" required>
                                <option value="">Nazwa usługi</option>
                            </select>
                            <br><br>

                            <label for="opis">Opis wizyty:</label><br>
                            <textarea id="opis" name="opis" rows="4" cols="50" placeholder="Powód wizyty"></textarea><br><br>

                            <input type="submit" value="Zapisz wizytę">
                        </form>
                    </div>
                </div>
                <div class="clr"></div>
            </div>
        </div>

        <script type="text/javascript">
            function showCookiePolicy() {
                document.getElementById("cookieModal").style.display = "block";
            }
        </script>

        <div class="fbg">
            <div class="fbg_resize">
                <div class="contact_wrapper">
                    <div class="contact_left">
                        <p><strong>Poniedziałek:</strong> 08:00 – 16:00</p>
                        <p><strong>Wtorek:</strong> 08:00 – 16:00</p>
                        <p><strong>Środa:</strong> 08:00 – 16:00</p>
                        <p><strong>Czwartek:</strong> 08:00 – 16:00</p>
                        <p><strong>Piątek:</strong> 08:00 – 16:00</p>
                        <p><strong>Sobota:</strong> Nieczynne</p>
                        <p><strong>Niedziela:</strong> Nieczynne</p>
                    </div>
                    <div class="contact_right">
                        <p><strong>Email:</strong> <a href="mailto:kontakt@firma.pl">kontakt@firma.pl</a></p>
                        <p><strong>Telefon:</strong> <a href="tel:+48123456789">+48 123 456 789</a></p>
                        <p><strong>Adres:</strong> ul. Przykładowa 1, 00-001 Warszawa</p>
                        <p><a href="#" onclick="showCookiePolicy()">informacje o ciasteczkach</a></p>
                    </div>
                </div>
                <div class="clr"></div>
            </div>
        </div>
        <div class="footer">
            <div class="footer_resize">
                <div class="clr"></div>
            </div>
        </div>

        <!-- MODAL: ciasteczka -->
        <div id="cookieModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
            <div style="background:white; width:80%; max-width:700px; margin:10% auto; padding:20px; border-radius:10px;">
                <h2>Polityka ciasteczek</h2>
                <p style="text-align:justify; max-height:60vh; overflow-y:auto;">
                    Nasza strona internetowa używa ciasteczek, aby zapewnić Ci jak najlepsze doświadczenia podczas przeglądania.
                    Ciasteczka to małe pliki tekstowe przechowywane na Twoim urządzeniu, które pozwalają nam zapamiętać Twoje preferencje i ustawienia.<br><br>

                    <strong>Jakie ciasteczka stosujemy?</strong><br>
                    Ciasteczka niezbędne – umożliwiają prawidłowe funkcjonowanie strony, takie jak logowanie do konta.<br>
                    Ciasteczka analityczne – pozwalają analizować, jak użytkownicy korzystają ze strony.<br>
                    Ciasteczka marketingowe – służą do wyświetlania dopasowanych reklam.<br><br>

                    <strong>Zarządzanie ciasteczkami:</strong><br>
                    Możesz zarządzać ustawieniami w przeglądarce. Zablokowanie ciasteczek może wpłynąć na działanie strony.<br><br>

                    Klikając „Akceptuję” lub kontynuując korzystanie z naszej strony, wyrażasz zgodę na używanie ciasteczek zgodnie z naszą polityką.
                </p>
                <div style="text-align:center; margin-top:20px;">
                    <button onclick="document.getElementById('cookieModal').style.display='none';">Akceptuję</button>
                </div>

            </div>
        </div>

        <!-- GŁÓWNY SKRYPT DO WIZYT -->
        <script>
          const lekarzSelect  = document.getElementById('lekarz');
          const godzinaTiles  = document.getElementById('godzina-tiles');
          const hiddenInput   = document.getElementById('godzina');

          function pad(n) {
            return n < 10 ? '0' + n : '' + n;
          }

          const imie = localStorage.getItem("imie");

          async function zaladujLekarzy() {
            try {
              const token = localStorage.getItem("token");
              const res = await fetch('/api/uzytkownicy?rola=2', {
                headers: { Authorization: "Bearer " + token }
              });
              const data  = await res.json();
              const lekarze = Array.isArray(data) ? data : (data.users || []);

              const select = document.getElementById('lekarz');
              lekarze.forEach(l => {
                const opt  = document.createElement('option');
                opt.value  = l.id; // Id użytkownika z tabeli Użytkownicy
                opt.textContent = `dr ${l.imie} ${l.nazwisko}`;
                select.appendChild(opt);
              });
            } catch(err) {
              console.error('Błąd pobierania lekarzy:', err);
            }
          }
          document.addEventListener('DOMContentLoaded', zaladujLekarzy);

          const nazwisko = localStorage.getItem("nazwisko");

          if (imie && nazwisko) {
            document.getElementById("powitanie").textContent = `Witaj ${imie} ${nazwisko}!`;
          }

          // brak możliwości wyboru daty, która już minęła
          const dataInput = document.getElementById('data');
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          const minDate = `${year}-${month}-${day}`;
          dataInput.min = minDate;

          let pojedynczyZapis = false;

          document.getElementById('formWizyta').addEventListener('submit', async e => {
            e.preventDefault();

            if (pojedynczyZapis) return;
            pojedynczyZapis = true;

            const lekarzId    = parseInt(document.getElementById('lekarz').value, 10);
            const dataWizyty  = document.getElementById('data').value;
            const godzina     = document.getElementById('godzina').value;
            const opisZabiegu = document.getElementById('opis').value.trim();
            const uslugaId    = parseInt(document.getElementById('usluga').value, 10);

            if (!lekarzId || !dataWizyty || !godzina || !opisZabiegu || !uslugaId) {
              alert('Wypełnij wszystkie pola');
              pojedynczyZapis = false;
              return;
            }

            const idPacjenta = parseInt(localStorage.getItem('userId'), 10);
            if (!idPacjenta) {
              alert('Błąd: brak zalogowanego użytkownika');
              pojedynczyZapis = false;
              return;
            }

          try {
            const token = localStorage.getItem("token");
            if (!token) throw new Error("Brak tokenu, zaloguj się ponownie");

            const authHeaders = {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            };

            const resZ = await fetch('/api/zabiegi', {
              method: "POST",
              headers: authHeaders,
              body: JSON.stringify({
                DataZabiegu: dataWizyty,
                Opis: opisZabiegu
              })
            });

            const jsonZ = await resZ.json();
            if (!resZ.ok || !jsonZ.success) throw new Error(jsonZ.message || "Błąd /api/zabiegi");

            const resW = await fetch('/api/wizyty', {
              method: "POST",
              headers: authHeaders,
              body: JSON.stringify({
                idPacjent: idPacjenta,
                idDentysta: lekarzId,
                idUsługa: uslugaId,
                DzieńWizyty: dataWizyty,
                GodzinaWizyty: `${godzina}:00`
              })
            });

            const jsonW = await resW.json();
            if (!resW.ok || !jsonW.success) throw new Error(jsonW.message || "Błąd /api/wizyty");


            await window.zaladujWizyty?.();
            await sprawdzNieobecnoscIWywolajRender?.();
            document.getElementById('formWizyta').reset();

            window.pokazKomunikat?.("Wizyta została umówiona.", "sukces", 5000);
            console.log("toast po zapisie odpalony");


              // odświeżenie kafelek godzin
              if (typeof sprawdzNieobecnoscIWywolajRender === 'function') {
                sprawdzNieobecnoscIWywolajRender();
              }

              if (window.zaladujWizyty) {
                try {
                  await window.zaladujWizyty();
                } catch (e) {
                  console.error('Nie udało się odświeżyć wizyt po zapisie:', e);
                }
              }

              document.getElementById('formWizyta').reset();
            } catch (err) {
              alert('Błąd: ' + err.message);
            } finally {
              pojedynczyZapis = false;
            }

         });

          async function lekarzNieobecny(idUzytkownika, dataISO) {
            // mapowanie user -> lekarz
            const mapJson = await fetchJSON(`/api/lekarzPoUzytkowniku/${idUzytkownika}`);
            if (!mapJson.success) return true;

            const idLekarza = mapJson.idLekarze;

            const json = await fetchJSON(`/api/nieobecnosci?lekarzId=${idLekarza}&data=${dataISO}`);
            return json.nieobecny;
          }

          async function pobierzGrafik(idLekarza, dataISO) {
            const { success, grafik } = await fetchJSON(`/api/grafiki/${idLekarza}`);
            if (!success || !Array.isArray(grafik)) throw new Error('Błąd');

            const jsDay = new Date(dataISO).getDay();   // 0..6
            const idDnia = jsDay === 0 ? 7 : jsDay;
            const row = grafik.find(r => r.IdDnia === idDnia);

            return row ? { start: row.godzinyPracyOd, end: row.godzinyPracyDo }
                       : { start: null, end: null };
          }

          async function renderTimeTiles() {
            const idUzytkownika = lekarzSelect.value;
            const dataISO       = document.getElementById('data').value;

            godzinaTiles.innerHTML = '';
            hiddenInput.value = '';

            if (!idUzytkownika || !dataISO) return;

            let idLekarza;
            try {
              const mapJson = await fetchJSON(`/api/lekarzPoUzytkowniku/${idUzytkownika}`);
              if (!mapJson.success) {
                godzinaTiles.innerHTML = '<p style="color:red;">Brak danych lekarza.</p>';
                return;
              }
              idLekarza = mapJson.idLekarze;
            } catch (err) {
              console.error('Błąd mapowania lekarza:', err);
              godzinaTiles.innerHTML = '<p style="color:red;">Błąd danych lekarza.</p>';
              return;
            }

            try {
              const resNieob = await fetchJSON(`/api/nieobecnosci?lekarzId=${idLekarza}&data=${dataISO}`);
              if (!resNieob.success || resNieob.nieobecny) {
                godzinaTiles.innerHTML = '<p style="color:red;">Lekarz jest nieobecny tego dnia.</p>';
                return;
              }
            } catch (err) {
              console.error('Błąd sprawdzania nieobecności:', err);
              godzinaTiles.innerHTML = '<p style="color:red;">Nie udało się sprawdzić nieobecności.</p>';
              return;
            }

            let startH, startM, endH, endM;
            try {
              const { success, grafik } = await fetchJSON(`/api/grafiki/${idLekarza}`);
              if (!success || !Array.isArray(grafik)) throw new Error('Błąd');

              const jsDay  = new Date(dataISO).getDay();
              const idDnia = jsDay === 0 ? 7 : jsDay;
              const row    = grafik.find(r => r.IdDnia === idDnia);

              if (!row || !row.godzinyPracyOd || !row.godzinyPracyDo) {
                godzinaTiles.innerHTML = '<p style="color:red;">Brak grafiku na ten dzień.</p>';
                return;
              }
              [startH, startM] = row.godzinyPracyOd.split(':').map(Number);
              [endH,   endM]   = row.godzinyPracyDo.split(':').map(Number);
            } catch (err) {
              console.error('Błąd pobierania grafiku:', err);
              godzinaTiles.innerHTML = '<p style="color:red;">Błąd pobierania grafiku.</p>';
              return;
            }

            let zajeteSet = new Set();
            try {
              const zajete = await fetchJSON(
                `/api/zajete?lekarzId=${idLekarza}&data=${dataISO}&_=${Date.now()}`,
                { cache: 'no-store' }
              );
              zajeteSet = new Set(
                (Array.isArray(zajete) ? zajete : []).map(s =>
                  String(s).trim().slice(0,5)
                )
              );
              console.log('Zajete(norm):', [...zajeteSet]);
            } catch (err) {
              console.warn('Nie udało się pobrać zajętych godzin:', err);
            }

            // kafelki co 30 minut (08:00–18:00) z uwzględnieniem grafiku i zajętości
            for (let h = 8; h <= 18; h++) {
              for (const m of [0, 30]) {
                if (h === 18 && m > 0) continue;

                const timeStr   = `${pad(h)}:${pad(m)}`;
                const minut     = h * 60 + m;
                const minutOd   = startH * 60 + startM;
                const minutDo   = endH   * 60 + endM;

                const btn = document.createElement('button');
                btn.type  = 'button';
                btn.className = 'godzina-tile';
                btn.textContent = timeStr;

                if (minut < minutOd || minut > minutDo) {
                  btn.disabled = true;
                  btn.classList.add('unavailable');
                  btn.title = 'Poza grafikiem lekarza';
                } else if (zajeteSet.has(timeStr)) {
                  btn.disabled = true;
                  btn.classList.add('zajeta');
                  btn.title = 'Ten termin jest już zajęty';
                } else {
                  btn.onclick = () => {
                    document.querySelectorAll('.godzina-tile').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    hiddenInput.value = timeStr;
                  };
                }

                godzinaTiles.appendChild(btn);
              }
            }
          }

          async function sprawdzNieobecnoscIWywolajRender() {
            const idUzytkownika = document.getElementById('lekarz').value;
            const dataISO       = document.getElementById('data').value;
            const komunikatDiv  = document.getElementById('komunikatGrafik');

            godzinaTiles.innerHTML = '';
            hiddenInput.value      = '';
            komunikatDiv.textContent = '';

            if (!idUzytkownika || !dataISO) return;

            const nieobecny = await lekarzNieobecny(idUzytkownika, dataISO);

            if (nieobecny) {
              komunikatDiv.textContent = 'Wybrany lekarz ma w tym dniu nieobecność.';
              komunikatDiv.style.color = 'red';
              return;
            }

            komunikatDiv.textContent = '';
            komunikatDiv.style.color = '';
            renderTimeTiles();
          }

          async function fetchJSON(url, options = {}) {
            const token = localStorage.getItem('token');

            const headers = new Headers(options.headers || {});
            if (token) headers.set('Authorization', `Bearer ${token}`);
            if (options.body && !headers.has('Content-Type')) {
              headers.set('Content-Type', 'application/json');
            }

            const res = await fetch(url, { ...options, headers });

            const ct = res.headers.get('content-type') || '';
            const text = await res.text();

            if (!ct.includes('application/json')) {
              throw new Error(`HTTP ${res.status} ${url} => ${text.slice(0,80)}`);
            }

            const data = JSON.parse(text);
            if (!res.ok) throw new Error(data.message || `HTTP ${res.status} ${url}`);
            return data;
          }


          document.getElementById('lekarz').addEventListener('change', sprawdzNieobecnoscIWywolajRender);
          document.getElementById('data').addEventListener('change', sprawdzNieobecnoscIWywolajRender);
          if (lekarzSelect.value && document.getElementById('data').value) {
            sprawdzNieobecnoscIWywolajRender();
          }
        </script>

        <!-- MODAL: propozycja włączenia powiadomień push -->
        <div id="pushIntroModal" style="
          display:none;
          position:fixed;
          inset:0;
          background:rgba(0,0,0,0.5);
          z-index:9999;
        ">
          <div style="
            background:white;
            max-width:480px;
            margin:10% auto;
            padding:20px;
            border-radius:10px;
            font-size:14px;
          ">
            <h3>Powiadomienia o wizytach</h3>
            <p>
              Możemy wysyłać Ci krótkie powiadomienia w przeglądarce:
              o nowej rezerwacji, zmianie terminu i przypomnieniu przed wizytą.
            </p>
            <p>
              Dotyczy tylko tego urządzenia i tej przeglądarki. Możesz to później zmienić
              w zakładce „Wiadomości i powiadomienia”.
            </p>
            <div style="text-align:right; margin-top:15px;">
              <button id="pushIntroNo" style="margin-right:8px;">Może innym razem...</button>
              <button id="pushIntroYes">Chcę włączyć powiadomienia!</button>
            </div>
          </div>
        </div>

        <!-- SKRYPT: logika modala push-intro -->
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            if (!userId) return;

            if (!('Notification' in window) || !('serviceWorker' in navigator)) return;

            if (localStorage.getItem('pushAsked_' + userId)) return;

            const modal = document.getElementById('pushIntroModal');
            const btnYes = document.getElementById('pushIntroYes');
            const btnNo  = document.getElementById('pushIntroNo');
            if (!modal || !btnYes || !btnNo) return;

            modal.style.display = 'block';

            btnNo.onclick = () => {
              localStorage.setItem('pushAsked_' + userId, 'no');
              modal.style.display = 'none';
            };

            btnYes.onclick = () => {
              localStorage.setItem('pushAsked_' + userId, 'yes');
              modal.style.display = 'none';
              window.location.href = 'wiadomosci_uzytkownik.html?autoPush=1';
            };
          });

          // "/socket.io/socket.io.js" --- Node automatycznie serwuje ten plik z pamięci
        </script>

        <script src="/socket.io/socket.io.js"></script>
        <script src="/js/powiadomienia.js"></script>

</body>
</html>




